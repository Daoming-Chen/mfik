# 设计文档：MeanFlow IK 求解器

## 上下文 (Context)

### 背景
逆运动学（IK）是机器人控制的核心问题，需要从目标末端位姿反解关节角度。传统方法包括解析解（仅适用于特定机械臂）、数值优化（速度慢）和基于雅可比的迭代方法（奇异点问题）。深度学习方法具有潜力，但面临多解冲突和精度瓶颈。

### 约束
- 需要支持通用的 URDF 格式机器人模型
- 必须满足工业级精度要求（位置 < 5mm，姿态 < 5°）
- 推理延迟需小于 1ms 以满足实时控制需求
- 训练数据必须物理可靠，避免不可达配置
- 需要兼容 GPU 加速（PyTorch 生态）

### 利益相关者
- 机器人控制研究人员
- 工业自动化工程师
- 实时轨迹规划系统开发者

## 目标与非目标 (Goals / Non-Goals)

### 目标
1. 实现基于 MeanFlow Identity 的单步 IK 求解器
2. 支持从 URDF 文件加载任意机器人模型
3. 提供高精度、低延迟的 IK 推理接口
4. 构建物理可靠的训练数据生成管线
5. 验证在连续轨迹跟踪场景下的稳定性

### 非目标
- 不处理碰撞检测（仅关注运动学）
- 不优化多机械臂协同（单臂场景）
- 不支持闭链机构（仅支持串联机械臂）
- 不提供轨迹规划功能（仅求解单个位姿）

## 技术决策 (Decisions)

### 决策 1：使用 MeanFlow 而非标准 Flow Matching
**理由**：标准 Flow Matching 需要在推理时进行 ODE 数值积分（多步迭代），无法满足 < 1ms 的延迟要求。MeanFlow 通过学习平均速度场 $u(q, 0, 1)$，使网络能够通过单次前向传播直接获得完整位移 $q_1 = q_0 + u(q_0, 0, 1)$，实现真正的单步求解。

**替代方案考虑**：
- **传统 DNN 回归**：无法处理多解冲突，会输出多个解的平均值，导致不可达配置。
- **基于 GAN 的生成方法**：训练不稳定，难以保证精度。
- **扩散模型**：需要多步采样（> 10 步），延迟过高。

### 决策 2：逆向扰动采样（Reverse Perturbation Sampling）
**理由**：传统的"Closest IK"数据采样策略会在多解边界处引入速度场不连续（Voronoi Artifacts）。逆向扰动采样从精确解 $q^*$ 出发，添加高斯噪声生成输入 $q_{input} = q^* + \epsilon$，确保训练数据始终位于单一解的局部邻域内，保证速度场的光滑性。

**替代方案考虑**：
- **随机采样 + 最近邻匹配**：会导致多解边界处的跳变。
- **基于解流形采样**：理论优雅但实现复杂，需要显式建模解流形结构。

### 决策 3：宽而浅的网络架构（5-6 个 ResBlocks，隐层宽度 512-1024）
**理由**：IK 问题本质是坐标变换和三角函数拟合，宽度比深度更重要。浅层网络（12 层总深度）梯度传播顺畅，推理速度快（< 0.1ms）。宽隐层（1024 神经元）能够捕捉奇异点附近的高频变化，同时充分利用 GPU 并行计算能力。

**替代方案考虑**：
- **深层网络（> 20 层）**：推理延迟线性增加，容易过拟合。
- **Transformer 架构**：参数量大，推理慢，不适合低延迟场景。

### 决策 4：使用 PyTorch 的 `torch.func.jvp` 计算时间全导数
**理由**：MeanFlow 损失需要计算 $\frac{d}{dt} u_\theta = v_t \cdot \nabla_{q_t} u_\theta + \frac{\partial u_\theta}{\partial t}$。`torch.func.jvp` 可以在单次反向传播中高效计算 Jacobian-Vector Product，开销仅为标准反向传播的 ~16%，显著优于手动实现或符号微分。

**替代方案考虑**：
- **数值差分**：精度低，数值不稳定。
- **手动推导梯度**：容易出错，难以维护。

### 决策 5：模块化架构设计（robot, data, model, train, eval）
**理由**：将系统拆分为独立的功能模块，每个模块职责清晰：
- **robot 模块**：封装机器人运动学（URDF 解析、FK、数值 IK），与具体的学习方法解耦
- **data 模块**：通用的数据生成和加载逻辑，可被不同版本的模型复用
- **model 模块**：神经网络架构定义，支持多版本并存（v1, v2, ...）用于实验迭代
- **train 模块**：训练流程和损失函数，支持多版本并存以测试不同训练策略
- **eval 模块**：通用的推理和评估工具，独立于具体模型版本

**替代方案考虑**：
- **单文件实现**：适合原型验证，但难以维护和扩展
- **按功能分层（layers/models/trainers）**：传统架构模式，但不利于版本迭代管理

### 决策 6：支持多版本模型/训练同时存在
**理由**：IK 求解方法处于快速实验阶段，需要频繁尝试不同的网络架构（v1: ResNet-based, v2: Transformer-based）和训练策略（v1: MeanFlow, v2: Diffusion）。通过版本化目录结构（`model/v1/`, `model/v2/`），可以：
- 并行实验多种方法而不相互干扰
- 保留历史版本用于对比实验
- 在生产环境选择最优版本部署

**版本管理约定**：
- v1: 当前 MeanFlow 实现（ResNet + 单步推理）
- v2+: 预留给未来的改进方法（Diffusion, Transformer, 等）
- 每个版本独立维护，通过统一的接口与 data/eval 模块交互

### 决策 7：拆分 URDF 解析为独立的运动学模块
**理由**：将 `urdf.py` 的功能按职责分解：
- **urdf.py**：仅负责解析 URDF 文件，构建运动学树（链接、关节、DH 参数）
- **forward_kinematics.py**：基于 PyTorch 实现的可微分 FK，支持批量计算和自动微分
- **inverse_kinematics.py**：数值迭代 IK 算法（雅可比伪逆、阻尼最小二乘），作为 baseline 和数据生成工具

这种分解使得：
- URDF 解析逻辑可被多个模块复用（FK、数值 IK、学习 IK）
- FK 模块可独立优化和测试
- 数值 IK 可作为学习 IK 的对比 baseline

## 风险与权衡 (Risks / Trade-offs)

### 风险 1：训练数据精度依赖数值优化器
**缓解措施**：
- 使用 GPU 加速的阻尼最小二乘法（LMA），精度设为 $10^{-6}$
- 构建基础映射库 $\mathcal{D}_{base}$ 作为优化初值池，提升收敛速度
- 对优化失败的样本进行过滤，仅保留满足精度阈值的数据

### 风险 2：奇异点附近的精度退化
**缓解措施**：
- 在数据集中对奇异点附近区域进行过采样
- 使用自适应损失权重 $w = 1/(\|\Delta\|^2 + c)^p$，增强困难样本的学习
- 在推理时对奇异构型添加特殊处理（如 fallback 到数值优化）

### 风险 3：模型泛化到新机器人的能力
**权衡**：当前设计为单机器人模型（需要为每个机器人训练独立模型）。扩展到多机器人通用模型需要引入机器人参数化编码（如 DH 参数），增加架构复杂度，暂不纳入 MVP。

### 风险 4：JVP 计算在旧版 PyTorch 中不可用
**缓解措施**：
- 要求 PyTorch >= 1.13（`torch.func` 模块引入版本）
- 在 `requirements.txt` 中明确版本依赖
- 提供向后兼容的 fallback 实现（使用 `torch.autograd.grad`）

## 迁移计划 (Migration Plan)

### 阶段 1：核心框架搭建（第 1-2 周）
1. 集成 `urdf.py` 到 `mfik/robot.py`，封装 FK 接口
2. 实现基础的网络架构和训练循环
3. 构建小规模数据集（< 10k 样本）验证管线

### 阶段 2：数据工厂完善（第 3-4 周）
1. 实现 GPU 加速的数值优化器（精确解生成）
2. 构建基础映射库 $\mathcal{D}_{base}$
3. 实现逆向扰动采样策略
4. 生成大规模数据集（> 1M 样本）

### 阶段 3：训练与优化（第 5-6 周）
1. 实现 MeanFlow 损失和 JVP 计算
2. 添加自适应权重和数值安全机制
3. 在 Panda Arm 和 UR10 上训练模型
4. 超参数调优（学习率、批量大小、网络宽度）

### 阶段 4：评估与发布（第 7-8 周）
1. 实现静态位姿测试和连续轨迹跟踪评估
2. 性能基准测试（精度、延迟、成功率）
3. 文档和 API 示例
4. 发布预训练模型权重

### 回滚策略
- 在 MVP 阶段保留传统数值优化作为 baseline
- 如果 MeanFlow 方法未能达到精度目标，可 fallback 到标准 Flow Matching（多步推理）
- 数据集生成和模型训练解耦，可独立调试

## 开放问题 (Open Questions)

1. **Q**: 网络隐层宽度 512 vs 1024，在精度和速度之间如何权衡？  
   **A**: 待实验验证。计划在 Panda Arm 上进行消融实验。

2. **Q**: 是否需要对旋转关节的周期性（$\pm \pi$）进行特殊编码（如正弦编码）？  
   **A**: 初始版本使用原始角度 + 最短弧差分。如果出现周期性问题，再引入三角编码。

3. **Q**: 如何处理机械臂关节限位（joint limits）？  
   **A**: 在数据生成阶段过滤越界样本；推理时对输出添加硬裁剪。

4. **Q**: 是否需要引入位姿约束（如仅关注位置，忽略姿态）？  
   **A**: MVP 聚焦于完整的 SE(3) 位姿（位置 + 姿态）。如有需求，可在网络输入中添加 mask 参数。

